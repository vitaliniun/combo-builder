<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b0f14"/>
<title>Music Tag Combo Builder</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#0b0f14; --panel:#11161d; --border:#233046; --ink:#e6edf3; --ink-dim:#8b949e;
    --accent:#35c48f; --accent-dim:rgba(53, 196, 143, 0.15);
    --danger:#f85149; --danger-dim:rgba(248, 81, 73, 0.15);
    --warn:#d29922; --warn-dim:rgba(210, 153, 34, 0.15);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);padding-bottom:80px}
  .wrap{max-width:800px;margin:0 auto;padding:16px}
  
  /* Typography */
  h1{margin:0;font-size:20px;background:linear-gradient(90deg, #fff, #8b949e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;padding:10px 0}
  h3{margin:0 0 10px 0;font-size:13px;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);display:flex;justify-content:space-between;align-items:center}

  /* Components */
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .full{width:100%}
  
  .btn{background:var(--panel);border:1px solid var(--border);color:var(--ink);padding:12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s;flex:1;display:flex;justify-content:center;align-items:center;gap:6px}
  .btn:active{transform:scale(0.98)}
  .btn.primary{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
  .btn.danger{background:var(--danger-dim);border-color:var(--danger);color:var(--danger)}
  .btn.warn{background:var(--warn-dim);border-color:var(--warn);color:var(--warn)}
  
  input, select, textarea{width:100%;background:#0d1117;border:1px solid var(--border);color:var(--ink);padding:12px;border-radius:8px;font-size:14px;outline:none;font-family:inherit}
  input:focus, select:focus, textarea:focus{border-color:var(--accent)}

  /* Chips & Output */
  .chips{display:flex;flex-wrap:wrap;gap:6px;min-height:40px;margin-bottom:12px}
  .chip{background:#161b22;border:1px solid var(--border);padding:6px 10px;border-radius:20px;font-size:13px;display:flex;align-items:center;gap:6px;user-select:none;animation:fadeIn 0.2s}
  .chip .x{color:var(--danger);font-weight:bold;padding:0 4px;cursor:pointer}
  .output{background:#0d1117;border:1px dashed var(--border);padding:12px;border-radius:8px;font-family:monospace;color:var(--ink-dim);font-size:12px;word-break:break-all;line-height:1.4}

  /* Manager Modal */
  dialog{background:var(--panel);color:var(--ink);border:1px solid var(--border);border-radius:16px;width:95%;max-width:500px;padding:0;box-shadow:0 25px 50px rgba(0,0,0,0.8);max-height:85vh}
  dialog::backdrop{background:rgba(0,0,0,0.8);backdrop-filter:blur(2px)}
  .modal-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#0d1117}
  .tabs{display:flex;border-bottom:1px solid var(--border)}
  .tab{flex:1;text-align:center;padding:12px;cursor:pointer;background:var(--panel);color:var(--ink-dim);font-size:14px}
  .tab.active{background:var(--accent-dim);color:var(--accent);font-weight:bold;border-bottom:2px solid var(--accent)}
  
  .modal-body{padding:10px;overflow-y:auto;height:60vh}
  .list-item{background:#0d1117;border:1px solid var(--border);padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .item-info{flex:1;overflow:hidden}
  .item-title{font-weight:bold;color:var(--ink);font-size:14px;margin-bottom:4px}
  .item-sub{font-size:11px;color:var(--ink-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .actions{display:flex;gap:8px}
  .icon-btn{padding:8px;background:none;border:none;cursor:pointer;font-size:16px;border-radius:6px}
  .icon-btn:hover{background:rgba(255,255,255,0.1)}

  @keyframes fadeIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
  
  /* Install Button */
  #installBtn{display:none;margin-bottom:16px;width:100%}
</style>
</head>
<body>

<div class="wrap">
  <h1>Music Tag Combo Builder</h1>
  <button id="installBtn" class="btn primary">üì≤ Instalar App</button>

  <div class="card" style="border-top: 3px solid var(--accent)">
    <h3>Abrir Combo</h3>
    <div class="row" style="margin-bottom:12px">
      <select id="famSelect" style="flex:1"><option value="">Fam√≠lia...</option></select>
      <select id="comboSelect" style="flex:1.5" disabled><option value="">Selecione Fam√≠lia...</option></select>
    </div>
    
    <div id="chipContainer" class="chips"></div>
    <div class="output" id="finalText">...</div>

    <div class="row" style="margin-top:16px">
      <button id="copyBtn" class="btn primary">Copiar</button>
      <button id="undoBtn" class="btn">Desfazer</button>
      <button id="clearBtn" class="btn danger">Limpar</button>
    </div>
  </div>

  <div class="card" style="border-top: 3px solid var(--warn)">
    <h3>Criar / Editar Combo</h3>
    <textarea id="pasteArea" rows="3" placeholder="Cole tags aqui (ex: rock, fast, male vocals) ou digite para criar novo..."></textarea>
    <button id="processPasteBtn" class="btn" style="margin:8px 0;background:#0d1117;font-size:12px">‚¨á Transformar texto em Tags (Pr√©-visualizar)</button>
    
    <div class="row">
      <input id="saveName" placeholder="Nome do Combo">
      <input id="saveFam" placeholder="Fam√≠lia (ex: Bandas)">
    </div>
    <button id="saveBtn" class="btn warn" style="margin-top:12px">üíæ Salvar na Biblioteca</button>
  </div>

  <div class="card">
    <h3>Biblioteca</h3>
    <button id="openManagerBtn" class="btn" style="width:100%;margin-bottom:12px">‚öôÔ∏è Gerenciar Combos e Fam√≠lias</button>
    <div class="row">
      <button id="exportBtn" class="btn" style="font-size:12px">‚¨á Backup</button>
      <label class="btn" style="font-size:12px;position:relative">
        ‚¨Ü Restaurar
        <input type="file" id="importInput" hidden accept=".json">
      </label>
    </div>
  </div>
</div>

<dialog id="managerModal">
  <div class="modal-head">
    <span style="font-weight:bold">Gerenciador</span>
    <button id="closeManager" class="icon-btn">‚úï</button>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="combos">Combos</div>
    <div class="tab" data-tab="families">Fam√≠lias</div>
  </div>
  <div style="padding:10px;background:#0d1117;border-bottom:1px solid var(--border)">
    <input id="searchManager" placeholder="Filtrar...">
  </div>
  <div class="modal-body" id="managerList"></div>
</dialog>

<script>
const DB_KEY = 'mtb_v3_db';
let state = { tags: [], history: [] };

/* --- DATABASE --- */
const DB = {
  get: () => { try{ return JSON.parse(localStorage.getItem(DB_KEY)) || [] }catch{ return [] } },
  set: (data) => localStorage.setItem(DB_KEY, JSON.stringify(data)),
  add: (item) => {
    let list = DB.get().filter(i => i.name !== item.name);
    list.push(item);
    list.sort((a,b) => a.name.localeCompare(b.name));
    DB.set(list);
  },
  del: (name) => DB.set(DB.get().filter(i => i.name !== name)),
  renameFam: (oldFam, newFam) => {
    let list = DB.get();
    list.forEach(item => {
      const parts = item.name.split('‚Äî');
      const f = parts[0].trim();
      const n = parts.slice(1).join('‚Äî').trim();
      if(f === oldFam) item.name = `${newFam} ‚Äî ${n}`;
    });
    list.sort((a,b) => a.name.localeCompare(b.name));
    DB.set(list);
  }
};

/* --- CORE LOGIC --- */
const $ = id => document.getElementById(id);
const sanitize = s => s.toString().trim().toLowerCase();
const unique = arr => [...new Set(arr)];

function render(){
  const box = $('chipContainer');
  box.innerHTML = '';
  state.tags.forEach(t => {
    const el = document.createElement('div');
    el.className = 'chip';
    el.innerHTML = `<span>${t}</span><span class="x">√ó</span>`;
    el.querySelector('.x').onclick = () => { pushHist(); state.tags = state.tags.filter(x => x !== t); render(); };
    box.appendChild(el);
  });
  $('finalText').textContent = state.tags.join(', ');
}

function pushHist(){
  state.history.push([...state.tags]);
  if(state.history.length > 20) state.history.shift();
}

function processTags(txt){
  if(!txt.trim()) return;
  pushHist();
  const parts = txt.split(/[,;\n]/).map(sanitize).filter(Boolean);
  state.tags = unique([...state.tags, ...parts]);
  render();
}

/* --- UI HELPERS --- */
function updateMenus(selectFam = null, selectCombo = null){
  const all = DB.get();
  const fams = unique(all.map(i => i.name.split('‚Äî')[0].trim())).sort();
  
  const famSel = $('famSelect');
  const currentFam = selectFam || famSel.value;
  
  famSel.innerHTML = '<option value="">Fam√≠lia...</option>';
  fams.forEach(f => famSel.innerHTML += `<option value="${f}">${f}</option>`);
  
  if(currentFam && fams.includes(currentFam)) famSel.value = currentFam;
  updateCombos(selectCombo);
}

function updateCombos(selectCombo = null){
  const fam = $('famSelect').value;
  const comboSel = $('comboSelect');
  comboSel.innerHTML = '<option value="">Selecione Combo...</option>';
  comboSel.disabled = !fam;
  
  if(fam){
    const items = DB.get().filter(i => i.name.startsWith(fam));
    items.forEach(i => {
      const cleanName = i.name.split('‚Äî').slice(1).join('‚Äî').trim();
      comboSel.innerHTML += `<option value="${i.name}">${cleanName}</option>`;
    });
    if(selectCombo) comboSel.value = selectCombo;
  }
}

/* --- MANAGER LOGIC --- */
let currentTab = 'combos';

function renderManager(filter = ''){
  const list = $('managerList');
  list.innerHTML = '';
  const term = filter.toLowerCase();
  const all = DB.get();

  if(currentTab === 'combos'){
    const data = all.filter(i => i.name.toLowerCase().includes(term));
    if(!data.length) return list.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.5">Nada encontrado.</div>';
    
    data.forEach(item => {
      const [fam, ...rest] = item.name.split('‚Äî');
      const name = rest.join('‚Äî').trim();
      
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <div class="item-info">
          <div class="item-title">${name}</div>
          <div class="item-sub" style="color:var(--accent)">${fam.trim()}</div>
          <div class="item-sub">${item.tags.join(', ')}</div>
        </div>
        <div class="actions">
          <button class="icon-btn edit" title="Editar">‚úèÔ∏è</button>
          <button class="icon-btn del" title="Excluir" style="color:var(--danger)">üóëÔ∏è</button>
        </div>
      `;
      // EDITAR
      div.querySelector('.edit').onclick = () => {
        $('managerModal').close();
        $('saveName').value = name;
        $('saveFam').value = fam.trim();
        $('pasteArea').value = ''; 
        state.tags = [...item.tags]; // Carrega tags
        render();
        window.scrollTo({top: 200, behavior: 'smooth'}); // Rola para o editor
        alert(`Combo "${name}" carregado para edi√ß√£o.`);
      };
      // EXCLUIR
      div.querySelector('.del').onclick = () => {
        if(confirm('Excluir combo?')) { DB.del(item.name); renderManager(filter); updateMenus(); }
      };
      list.appendChild(div);
    });

  } else { // FAMILIES TAB
    const fams = unique(all.map(i => i.name.split('‚Äî')[0].trim())).sort();
    const filteredFams = fams.filter(f => f.toLowerCase().includes(term));
    
    if(!filteredFams.length) return list.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.5">Nenhuma fam√≠lia encontrada.</div>';

    filteredFams.forEach(f => {
      const count = all.filter(i => i.name.startsWith(f)).length;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <div class="item-info">
          <div class="item-title">${f}</div>
          <div class="item-sub">${count} combos</div>
        </div>
        <div class="actions">
          <button class="icon-btn edit" title="Renomear">‚úèÔ∏è</button>
          <button class="icon-btn del" title="Excluir Tudo" style="color:var(--danger)">üóëÔ∏è</button>
        </div>
      `;
      // RENOMEAR FAM√çLIA
      div.querySelector('.edit').onclick = () => {
        const newName = prompt('Novo nome para a fam√≠lia:', f);
        if(newName && newName !== f){
          DB.renameFam(f, newName);
          renderManager(filter);
          updateMenus();
        }
      };
      // EXCLUIR FAM√çLIA
      div.querySelector('.del').onclick = () => {
        if(confirm(`ATEN√á√ÉO: Isso vai excluir TODOS os ${count} combos da fam√≠lia "${f}". Tem certeza?`)){
          const toKeep = DB.get().filter(i => !i.name.startsWith(f));
          DB.set(toKeep);
          renderManager(filter);
          updateMenus();
        }
      };
      list.appendChild(div);
    });
  }
}

/* --- EVENTS --- */
document.addEventListener('DOMContentLoaded', () => {
  // Init
  updateMenus();

  // Block 1: Player
  $('famSelect').onchange = () => updateCombos();
  $('comboSelect').onchange = (e) => {
    const item = DB.get().find(i => i.name === e.target.value);
    if(item) { pushHist(); state.tags = unique([...state.tags, ...item.tags]); render(); }
  };
  $('copyBtn').onclick = () => { navigator.clipboard.writeText($('finalText').textContent); alert('Tags copiadas!'); };
  $('clearBtn').onclick = () => { pushHist(); state.tags = []; render(); };
  $('undoBtn').onclick = () => { if(state.history.length){ state.tags = state.history.pop(); render(); } };

  // Block 2: Creator
  $('processPasteBtn').onclick = () => {
    processTags($('pasteArea').value);
    $('pasteArea').value = '';
  };
  $('saveBtn').onclick = () => {
    const n = $('saveName').value.trim();
    const f = $('saveFam').value.trim();
    if(!n || !f || !state.tags.length) return alert('Preencha Nome, Fam√≠lia e tenha tags carregadas.');
    const fullName = `${f} ‚Äî ${n}`;
    DB.add({ name: fullName, tags: state.tags });
    updateMenus(f, fullName);
    alert('Combo salvo!');
    $('saveName').value = '';
  };

  // Block 3: Library
  $('exportBtn').onclick = () => {
    const blob = new Blob([JSON.stringify(DB.get(), null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'backup_v3.json';
    a.click();
  };
  $('importInput').onchange = (e) => {
    const fr = new FileReader();
    fr.onload = (res) => {
      try {
        const json = JSON.parse(res.target.result);
        const data = Array.isArray(json) ? json : (json.combos || []);
        data.forEach(d => DB.add(d));
        updateMenus();
        alert('Biblioteca importada!');
      } catch(e) { alert('Erro no arquivo.'); }
    };
    if(e.target.files[0]) fr.readAsText(e.target.files[0]);
  };

  // Manager Modal
  $('openManagerBtn').onclick = () => { renderManager(); $('managerModal').showModal(); };
  $('closeManager').onclick = () => $('managerModal').close();
  $('searchManager').oninput = (e) => renderManager(e.target.value);
  
  document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      currentTab = t.dataset.tab;
      renderManager($('searchManager').value);
    };
  });

  // PWA
  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    const btn = $('installBtn');
    btn.style.display = 'block';
    btn.onclick = () => e.prompt();
  });
});
</script>
</body>
</html>
